<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Voice Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 1200px;
            min-height: 80vh;
            overflow: hidden;
            display: grid;
            grid-template-columns: 300px 1fr;
            position: relative;
        }

        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
            font-size: 24px;
            font-weight: bold;
        }

        .logo::before {
            content: "üè•";
            margin-right: 10px;
            font-size: 28px;
        }

        .api-section {
            margin-bottom: 30px;
        }

        .api-section h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: #bdc3c7;
        }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #34495e;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .api-input::placeholder {
            color: #bdc3c7;
        }

        .api-input:focus {
            outline: none;
            border-color: #3498db;
            background: rgba(255,255,255,0.2);
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-area {
            border: 2px dashed #34495e;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .upload-area.dragover {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .file-input {
            display: none;
        }

        .uploaded-files {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .file-item button {
            background: #e74c3c;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .header {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 300;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #95a5a6;
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: #27ae60;
        }

        .status-dot.speaking {
            background: #e74c3c;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 15px;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .avatar.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .avatar.assistant {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        .message-content {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.6;
            color: #2c3e50;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .control-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .start-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }

        .stop-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .stop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .clear-btn {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(149, 165, 166, 0.3);
        }

        .transcript-area {
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #2c3e50;
            min-height: 60px;
            white-space: pre-wrap;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffe6e6;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .sidebar {
                padding: 20px;
            }
            
            .controls {
                flex-wrap: wrap;
                padding: 20px;
            }
            
            .control-btn {
                min-width: 120px;
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">MedVoice AI</div>
            
            <div class="api-section">
                <h3>OpenAI Configuration</h3>
                <input type="password" class="api-input" id="apiKey" placeholder="Enter your OpenAI API Key" />
                <select class="api-input" id="modelSelect">
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
            </div>

            <div class="upload-section">
                <h3>Knowledge Base</h3>
                <div class="upload-area" id="uploadArea">
                    <div>üìÅ Drop files here or click to browse</div>
                    <div style="font-size: 12px; margin-top: 10px; color: #bdc3c7;">
                        Supports: PDF, TXT, DOCX, MP3, PNG, JPG
                    </div>
                </div>
                <input type="file" class="file-input" id="fileInput" multiple accept=".pdf,.txt,.docx,.mp3,.png,.jpg,.jpeg" />
                <div class="uploaded-files" id="uploadedFiles"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>Medical Consultation Assistant</h1>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Ready</span>
                </div>
            </div>

            <div class="chat-area" id="chatArea">
                <div class="message assistant">
                    <div class="avatar assistant">üè•</div>
                    <div class="message-content">
                        Hello! I'm your medical consultation assistant. I can help analyze your documents and discuss medical concerns. Please upload any relevant medical documents and configure your OpenAI API key to get started.
                    </div>
                </div>
            </div>

            <div class="transcript-area" id="transcriptArea">
                Voice transcript will appear here...
            </div>

            <div class="controls">
                <button class="control-btn start-btn" id="startBtn">
                    üé§ Start Listening
                </button>
                <button class="control-btn stop-btn" id="stopBtn" style="display: none;">
                    ‚èπÔ∏è Stop Listening
                </button>
                <button class="control-btn clear-btn" id="clearBtn">
                    üóëÔ∏è Clear Chat
                </button>
            </div>
        </div>
    </div>

    <script>
        class MedicalVoiceAssistant {
            constructor() {
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.isListening = false;
                this.isProcessing = false;
                this.uploadedFiles = [];
                this.conversationHistory = [];
                this.currentTranscript = '';
                
                this.initializeElements();
                this.initializeSpeechRecognition();
                this.initializeEventListeners();
            }

            initializeElements() {
                this.elements = {
                    apiKey: document.getElementById('apiKey'),
                    modelSelect: document.getElementById('modelSelect'),
                    uploadArea: document.getElementById('uploadArea'),
                    fileInput: document.getElementById('fileInput'),
                    uploadedFiles: document.getElementById('uploadedFiles'),
                    chatArea: document.getElementById('chatArea'),
                    transcriptArea: document.getElementById('transcriptArea'),
                    startBtn: document.getElementById('startBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    statusDot: document.getElementById('statusDot'),
                    statusText: document.getElementById('statusText')
                };
            }

            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                } else if ('SpeechRecognition' in window) {
                    this.recognition = new SpeechRecognition();
                } else {
                    this.showError('Speech recognition is not supported in this browser.');
                    return;
                }

                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'en-US';

                this.recognition.onstart = () => {
                    this.updateStatus('listening', 'Listening...');
                    this.isListening = true;
                };

                this.recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    this.currentTranscript = finalTranscript + interimTranscript;
                    this.elements.transcriptArea.textContent = this.currentTranscript;

                    if (finalTranscript) {
                        this.processUserInput(finalTranscript.trim());
                    }
                };

                this.recognition.onerror = (event) => {
                    this.showError(`Speech recognition error: ${event.error}`);
                    this.stopListening();
                };

                this.recognition.onend = () => {
                    if (this.isListening) {
                        this.recognition.start(); // Restart for continuous listening
                    }
                };
            }

            initializeEventListeners() {
                this.elements.startBtn.addEventListener('click', () => this.startListening());
                this.elements.stopBtn.addEventListener('click', () => this.stopListening());
                this.elements.clearBtn.addEventListener('click', () => this.clearChat());
                
                this.elements.uploadArea.addEventListener('click', () => this.elements.fileInput.click());
                this.elements.uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                this.elements.uploadArea.addEventListener('drop', this.handleDrop.bind(this));
                this.elements.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
            }

            startListening() {
                if (!this.elements.apiKey.value.trim()) {
                    this.showError('Please enter your OpenAI API key first.');
                    return;
                }

                if (this.recognition) {
                    this.recognition.start();
                    this.elements.startBtn.style.display = 'none';
                    this.elements.stopBtn.style.display = 'flex';
                }
            }

            stopListening() {
                this.isListening = false;
                if (this.recognition) {
                    this.recognition.stop();
                }
                this.updateStatus('ready', 'Ready');
                this.elements.startBtn.style.display = 'flex';
                this.elements.stopBtn.style.display = 'none';
                this.elements.transcriptArea.textContent = 'Voice transcript will appear here...';
            }

            async processUserInput(input) {
                if (this.isProcessing || !input.trim()) return;

                this.isProcessing = true;
                this.updateStatus('processing', 'Processing...');
                
                this.addMessage('user', input);
                
                try {
                    const response = await this.callOpenAI(input);
                    this.addMessage('assistant', response);
                    this.speakText(response);
                } catch (error) {
                    this.showError(`Error processing request: ${error.message}`);
                } finally {
                    this.isProcessing = false;
                    this.updateStatus('listening', 'Listening...');
                }
            }

            async callOpenAI(message) {
                const apiKey = this.elements.apiKey.value.trim();
                const model = this.elements.modelSelect.value;

                const messages = [
                    {
                        role: 'system',
                        content: `You are a professional medical consultation assistant. You help analyze medical documents and provide informative responses about health concerns. Always remind users that your advice is for informational purposes only and they should consult with healthcare professionals for medical decisions.

                        Available documents: ${this.getDocumentSummary()}`
                    },
                    ...this.conversationHistory.slice(-10), // Keep last 10 messages for context
                    { role: 'user', content: message }
                ];

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;
                
                this.conversationHistory.push({ role: 'user', content: message });
                this.conversationHistory.push({ role: 'assistant', content: assistantMessage });
                
                return assistantMessage;
            }

            speakText(text) {
                this.synthesis.cancel(); // Cancel any ongoing speech
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                
                utterance.onstart = () => {
                    this.updateStatus('speaking', 'Speaking...');
                };
                
                utterance.onend = () => {
                    if (this.isListening) {
                        this.updateStatus('listening', 'Listening...');
                    } else {
                        this.updateStatus('ready', 'Ready');
                    }
                };
                
                this.synthesis.speak(utterance);
            }

            addMessage(type, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const avatar = document.createElement('div');
                avatar.className = `avatar ${type}`;
                avatar.textContent = type === 'user' ? 'üë§' : 'üè•';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
                
                this.elements.chatArea.appendChild(messageDiv);
                this.elements.chatArea.scrollTop = this.elements.chatArea.scrollHeight;
            }

            handleDragOver(e) {
                e.preventDefault();
                this.elements.uploadArea.classList.add('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                this.elements.uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                this.handleFiles(files);
            }

            handleFileSelect(e) {
                const files = Array.from(e.target.files);
                this.handleFiles(files);
            }

            handleFiles(files) {
                files.forEach(file => {
                    if (this.isValidFileType(file)) {
                        this.uploadedFiles.push(file);
                        this.addFileToUI(file);
                    } else {
                        this.showError(`File type ${file.name} is not supported.`);
                    }
                });
            }

            isValidFileType(file) {
                const validTypes = [
                    'application/pdf',
                    'text/plain',
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    'audio/mpeg',
                    'audio/mp3',
                    'image/png',
                    'image/jpeg',
                    'image/jpg'
                ];
                return validTypes.includes(file.type) || file.name.toLowerCase().endsWith('.txt');
            }

            addFileToUI(file) {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                
                fileDiv.innerHTML = `
                    <span>üìÑ ${file.name} (${this.formatFileSize(file.size)})</span>
                    <button onclick="medicalAssistant.removeFile('${file.name}')">√ó</button>
                `;
                
                this.elements.uploadedFiles.appendChild(fileDiv);
            }

            removeFile(fileName) {
                this.uploadedFiles = this.uploadedFiles.filter(file => file.name !== fileName);
                this.updateFileUI();
            }

            updateFileUI() {
                this.elements.uploadedFiles.innerHTML = '';
                this.uploadedFiles.forEach(file => this.addFileToUI(file));
            }

            getDocumentSummary() {
                if (this.uploadedFiles.length === 0) {
                    return 'No documents uploaded.';
                }
                
                const summary = this.uploadedFiles.map(file => 
                    `${file.name} (${file.type || 'unknown type'})`
                ).join(', ');
                
                return `Uploaded documents: ${summary}`;
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            updateStatus(status, text) {
                this.elements.statusDot.className = `status-dot ${status}`;
                this.elements.statusText.textContent = text;
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                
                this.elements.chatArea.appendChild(errorDiv);
                this.elements.chatArea.scrollTop = this.elements.chatArea.scrollHeight;
                
                setTimeout(() => errorDiv.remove(), 5000);
            }

            clearChat() {
                this.elements.chatArea.innerHTML = `
                    <div class="message assistant">
                        <div class="avatar assistant">üè•</div>
                        <div class="message-content">
                            Hello! I'm your medical consultation assistant. I can help analyze your documents and discuss medical concerns. Please upload any relevant medical documents and configure your OpenAI API key to get started.
                        </div>
                    </div>
                `;
                this.conversationHistory = [];
                this.elements.transcriptArea.textContent = 'Voice transcript will appear here...';
            }
        }

        // Initialize the application
        const medicalAssistant = new MedicalVoiceAssistant();
    </script>
</body>
</html>